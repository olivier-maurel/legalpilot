{% extends 'base.html.twig' %}

{% block title %}Hello IndexController!{% endblock %}

{% block body %}
<div class="px-1">
    <div class="card w-100 py-2 px-1">
        <div class="flex-center">
            {% for character in characters %}
                <a title="{{ character.name }}" data-char="{{ character.id }}" class="mx-1 shadow pointer select-char">
                    <img src="{{ character.image }}" alt="Image du personnage {{ character.name }}" width="150px">
                </a>
            {% endfor %}
        </div>
    </div>
    <div class="flex-column flex-center">
        <h2 class="text-center mt-5">Choisissez les équipes</h2>
        <a id="selectRandom" class="btn btn-info text-white"><i class="fa fa-redo"></i> Aléatoire</a>
    </div>
    <div class="flex-center-btw">
        <div id="f_team" class="col-lg-4">
            <h3 class="text-primary text-center">Equipe1</h3>
        </div>
        <div>
            <a id="btnFight" class="btn btn-lg btn-danger mt-5">FIGHT !</a>
        </div>
        <div id="s_team" class="col-lg-4">
            <h3 class="text-danger text-center">Equipe2</h3>
        </div>
    </div>
</div>

<div id="fightContainer" class="dark-card" style="display: none;">
    <div class="h-100 m-auto">
        <div class="card bg-dark h-100 flex-center">
            <div id="fightCard" class="flex-center text-white flex-column">
                <i id="loader" class="fa fa-redo rotate h1 mb-5"></i>
                <h3 id="currentFightText">Le sons des tambours résonnent...</h3>
                <h2 id="fightTeamWin"></h2>
                <div id="fightWinner" class="my-2 row flex-center-eve"></div>
                <div id="fightLogs" class="h-25 my-3 overflow-auto"></div>
                <a id="closeFight" class="btn btn-sm btn-danger">Fermer</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    
    //
    $(document.body).on('click', '.select-char', function(){

        let $this = $(this);

        if ($this.hasClass('disabled')) 
            return;
        else
            $.post("{{ path('select-char') }}", {character: $this.data('char')}, function(data){
                if (data.success === true) {
                    $('#' + data.team).append(data.html);
                    $this.addClass('disabled');
                }
            });

    });

    //
    $(document.body).on('click', '#selectRandom', function(){

        let available = $('.select-char:not(.disabled)').toArray();

        $.post("{{ path('check') }}", function(data){
            for (let i = data.selected; i < 4; i++) {
                nbr = randomNumber(0, available.length);    
                available[nbr].click();
                available.splice(nbr, 1);
            }
        });

    });

    $(document.body).on('click', '#btnFight', function(){

        $.post("{{ path('check') }}", function(data){
            if (data.selected.length !== 4)
                return;

            $('#fightContainer').show();
            
            $.post("{{ path('fighting') }}", function(data){
                setTimeout(() => {
                    $('#currentFightText').text('Le fer des épées s\'entrecroisent ...');
                }, 2000);

                setTimeout(() => {
                    $('#currentFightText').text('La lutte est sanglante ...');
                }, 4000);

                setTimeout(() => {
                    $('#currentFightText').text('Résultat de la bataille !');
                    $('#loader').hide();

                    if (data.team.id == 1)
                        color = 'primary';
                    else color = 'danger';

                    $('#fightTeamWin').text('Equipe ' + data.team.id).addClass('text-'+color);

                    data.html.forEach(element => {
                        $('#fightWinner').append('<div class="col-lg-5">'+element+'</div>');
                    });
                    $.each(data.logs, function(k,log) {
                        let logger = $('<small>').addClass('mb-1 w-100').css('font-size','x-small');
                        let message = '';

                        console.log(log.team)

                        if (log.team == 1)
                            logger.addClass('text-primary');
                        else 
                            logger.addClass('text-danger');

                        if (log.damage != null)
                            message = 'Equipe '+ log.team +' a réussi son attaque avec '+ log.attack +'% de blesser et '+ log.lucky +'% de chance de toucher.<br>Equipe adverse perd '+ log.damage +' dommage, elle lui reste désormet '+ log.health +' PV.<br>';
                        else
                            message = 'Equipe '+ log.team +' a échoué son attaque avec '+ log.attack +'% de blesser et '+ log.lucky +'% de chance de toucher.<br>Equipe adverse ne perd aucun PV.<br>';

                        logger.html(message);
                        $('#fightLogs').append(logger);
                    });
                
                }, 6000);
            });
            
        });

    });

    $(document.body).on('click', '#closeFight', function(){
        $('#fightContainer').hide();
        $(location).attr("href", "/fight");
    });

    //
    function randomNumber(min = 0, max) {
        return Math.floor(Math.random() * (max - min) + min);
    }
</script>
{% endblock %}